    #å¤ä½å‚æ•°
    def reset_application(self):
        if not messagebox.askyesno("Reset Application", "Reset Application to initial state?"):
            return

        # ------------------------------------------------------------
        # âš ï¸ OPTIMIZATION START: æš‚æ—¶ç¦ç”¨ç»˜å›¾æ›´æ–° (self.update_plots)
        # ------------------------------------------------------------
        if hasattr(self, 'update_plots'):
            self._original_update_plots = self.update_plots
            def no_op_update_plots(*args, **kwargs):
                pass
            self.update_plots = no_op_update_plots

        # ------------------------------------------------------------
        # 0. Reset Core Data Structures
        # ------------------------------------------------------------
        self.datasets = []
        self.next_dataset_id = 1
        
        # >>>>>>>>>> æ·»åŠ è¿™å‡ è¡Œ <<<<<<<<<<
        if hasattr(self, 'display_vars'):
            self.display_vars.clear()  # ä¸€è¡Œå°±å¤Ÿäº†ï¼æœ€ç®€æ´æœ‰æ•ˆ
        # >>>>>>>>>> ç»“æŸ <<<<<<<<<<
        
        self.current_img = None
        self.maximized_param = None
        self.custom_id_names = {}

        # Disable Add Tag (default)
        if hasattr(self, 'marker_click_enabled'):
            self.marker_click_enabled.set(False)

        # Disable refresh (default)
        if hasattr(self, 'freeze_refresh_var'):
            self.freeze_refresh_var.set(False)

        # Disable limits check (default)
        if hasattr(self, 'limits_check_enabled'):
            self.limits_check_enabled.set(False)

        # Disable Marker Legend Color (default)
        if hasattr(self, 'auto_font_color_enabled'):
            self.auto_font_color_enabled.set(False)

        # ------------------------------------------------------------
        # 1. Clear limit lines, markers and UI references
        # ------------------------------------------------------------
        for plot_type in self.data:
            for param in self.params:

                # Remove limit lines
                if "limit_lines" in self.data[plot_type]:
                    self.data[plot_type]["limit_lines"][param] = []

                # Remove all marker entries (Regular + Search + Avg)
                if "marks" in self.data[plot_type]:
                    self.data[plot_type]["marks"][param] = []

                # ==== FIX: æ¸…ç©º Average UI frame ====
                if "ui_refs" in self.data[plot_type]:
                    ui_refs = self.data[plot_type]["ui_refs"][param]
                    if "avg_list_frame" in ui_refs:
                        for w in ui_refs["avg_list_frame"].winfo_children():
                            w.destroy()
                # =====================================

                # Finally remove ui_refs
                if "ui_refs" in self.data[plot_type]:
                    self.data[plot_type]["ui_refs"][param] = {}

        # ------------------------------------------------------------
        # 2. Reset UI: File Information Fields
        # ------------------------------------------------------------
        if hasattr(self, 'selected_data_id_var'):
            self.selected_data_id_var.set("")
        if hasattr(self, 'custom_name_var'):
            self.custom_name_var.set("")
        if hasattr(self, "id_combo"):
            self.id_combo.set("")
            self.id_combo["values"] = []

        # ------------------------------------------------------------
        # 3. Reset General Settings & Port Pair/S-Params (FIX)
        # ------------------------------------------------------------

        # 1. FIX: æš‚æ—¶ç§»é™¤ on_port_pair_change çš„ç›‘å¬ï¼Œé¿å… display_mode é‡ç½®å Port Pair å˜é‡çš„è®¾ç½®å¯¼è‡´äºŒæ¬¡ UI é‡å»º
        trace_id_to_remove = getattr(self, '_port_pair_change_trace_id', None)
        if trace_id_to_remove:
            try:
                self.port_selection_var.trace_remove("write", trace_id_to_remove)
            except tk.TclError:
                pass

        # 2. å¼ºåˆ¶è®¾ç½® Port Pair å’Œ S å‚æ•°åˆ°é»˜è®¤å€¼ (æ»¡è¶³ç”¨æˆ·è¦æ±‚)
        self.port_selection_var.set("1-2") # ç¡®ä¿ Port Pair å›åˆ° 1-2
        self.normal_mode_ports = (1, 2)
        self.default_params = ["S11", "S12", "S21", "S22"] # ç¡®ä¿ S å‚æ•°å›åˆ° S11, S12, S21, S22
        self.params = self.default_params.copy()

        # 3. ç¡®ä¿ S11, S12, S21, S22 çš„å¤é€‰æ¡†çŠ¶æ€æ˜¯ True
        for p in self.default_params:
            if p not in self.show_param_vars:
                self.show_param_vars[p] = tk.BooleanVar(value=True)
            self.show_param_vars[p].set(True)

        # 4. é‡ç½®æ ¸å¿ƒæ¨¡å¼å˜é‡ (æ­¤è°ƒç”¨ä¼šè§¦å‘ on_display_mode_change -> rebuild_show_paramsï¼Œå®Œæˆå•æ¬¡ UI é‡å»º)
        self.title_var.set("SN-001")
        self.plot_type.set("Magnitude (dB)")
        self.display_mode.set("Normal")

        SUPPORTED_PLOT_TYPES = ["Magnitude (dB)", "Phase (deg)", "Group Delay (ns)"]

        # ------------------------------------------------------------
        # 3. Reset Marker-Legend Positions (Normal & Max)
        # =========================================================
        DEFAULT_MODE = "Top Right"
        DEFAULT_X = "0.5"
        DEFAULT_Y = "0.5"

        # 3a. normal mode per-param
        if hasattr(self, "marker_pos_configs"):
            for pt, param_dict in self.marker_pos_configs.items():
                for param, cfg in param_dict.items():
                    try:
                        cfg["mode_var"].set(DEFAULT_MODE)
                        cfg["x_var"].set(DEFAULT_X)
                        cfg["y_var"].set(DEFAULT_Y)
                    except:
                        pass

        # 3b. max mode global position
        if hasattr(self, "max_marker_pos_configs"):
            for pt, cfg in self.max_marker_pos_configs.items():
                try:
                    cfg["mode_var"].set(DEFAULT_MODE)
                    cfg["x_var"].set(DEFAULT_X)
                    cfg["y_var"].set(DEFAULT_Y)
                except:
                    pass

        # Hide all Custom frames
        if hasattr(self, "normal_position_controls"):
            for param, ref in self.normal_position_controls.items():
                cf = ref.get("custom_frame")
                if cf:
                    try:
                        cf.pack_forget()
                    except:
                        pass

        if hasattr(self, "max_position_controls") and self.max_position_controls.get("custom_frame"):
            try:
                self.max_position_controls["custom_frame"].pack_forget()
            except:
                pass

        # =========================================================
        # 4. Reset S-Legend Position (Matplotlib Legend)
        # =========================================================
        if hasattr(self, "max_loc_var"):
            try:
                self.max_loc_var.set("Lower Left")
            except:
                pass

        if hasattr(self, "max_loc_custom_frame"):
            try:
                self.max_loc_custom_frame.pack_forget()
            except:
                pass

        # =========================================================
        # 5. Reset Parameter Visibility
        # =========================================================
        if hasattr(self, "show_param_vars"):
            for p, v in self.show_param_vars.items():
                try:
                    v.set(True)
                except:
                    pass

        # =========================================================
        # 5. Reset Data Dictionaries (limit lines, markers, UI refs)
        # ------------------------------------------------------------
        for pt in SUPPORTED_PLOT_TYPES:
            for p in self.params:
                self.data[pt]["limit_lines"][p] = []
                self.data[pt]["marks"][p] = []
                self.data[pt]["ui_refs"][p] = {}

        # ------------------------------------------------------------
        # 6. Reset Show/Hide Parameters
        # ------------------------------------------------------------
        for p in self.params:
            self.show_param_vars[p].set(True)

        # ------------------------------------------------------------
        # 7. Reset Axis Configurations
        # ------------------------------------------------------------
        self.axis_configs["x_mode"].set("Default")
        self.axis_configs["x_start"].set("800")
        self.axis_configs["x_stop"].set("1000")
        self.axis_configs["x_unit"].set("MHz")

        y_defaults = {
            "Magnitude (dB)": {"min": "-50", "max": "0"},
            "Phase (deg)": {"min": "-180", "max": "180"},
            "Group Delay (ns)": {"min": "0", "max": "10"}
        }

        for pt in SUPPORTED_PLOT_TYPES:
            for p in self.params:
                self.y_configs[pt][p]["mode"].set("Default")
                self.y_configs[pt][p]["min"].set(y_defaults[pt]["min"])
                self.y_configs[pt][p]["max"].set(y_defaults[pt]["max"])

        # ------------------------------------------------------------
        # 8. Close Max Mode Window (if any)
        # ------------------------------------------------------------
        if hasattr(self, 'max_frame') and self.max_frame:
            self.exit_max_mode()
            self.max_frame.destroy()
            self.max_frame = None
            self.max_fig = None
            self.max_ax = None
            self.max_canvas = None
            self.max_toolbar = None
            self.max_cids = {}

        # ------------------------------------------------------------
        # 9. Recreate Dynamic Tabs (Limit & Axis tabs)
        # ------------------------------------------------------------
        if hasattr(self, 'limit_tabs'):
            for t in list(self.limit_tabs.keys()):
                try:
                    w = self.limit_tabs.pop(t)
                    self.notebook.forget(w)
                    w.destroy()
                except:
                    pass

        # é‡æ–°åˆ›å»º Tabs
        self.create_limit_mark_tab(self.plot_type.get())
        self.create_data_information_tab()
        self.create_axis_control_tab()

        # ------------------------------------------------------------
        # 10. Reset Marker Legend Customization (Key Fix)
        # ------------------------------------------------------------
        if hasattr(self, "marker_legend_configs"):
            self.marker_legend_configs["boxstyle_var"].set("Default")
            self.marker_legend_configs["facecolor_var"].set("Default")
            self.marker_legend_configs["alpha_var"].set("Default")

        # Font settings
        if hasattr(self, "marker_font_color_var"):
            self.marker_font_color_var.set("black")
        if hasattr(self, "marker_font_size_var"):
            self.marker_font_size_var.set("10")
        if hasattr(self, "marker_bg_color_var"):
            self.marker_bg_color_var.set("yellow")
        if hasattr(self, "marker_show_var"):
            self.marker_show_var.set(True)

        # Refresh the legend UI (if supported)
        if hasattr(self, "refresh_marker_legend_ui"):
            try: self.refresh_marker_legend_ui()
            except: pass

        # Refresh legend on plot
        if hasattr(self, "update_marker_legend_display"):
            try: self.update_marker_legend_display()
            except: pass
            
        # ------------------------------------------------------------
        # 11. Reset Plot Logo
        # ------------------------------------------------------------
        if hasattr(self, '_clear_report_logo'):
            self._clear_report_logo()
        elif hasattr(self, 'report_logo_path'):
            self.report_logo_path = ""

        # ------------------------------------------------------------
        # âš ï¸ OPTIMIZATION END: æ¢å¤ç»˜å›¾æ›´æ–°å‡½æ•°
        # ------------------------------------------------------------
        if hasattr(self, '_original_update_plots'):
            self.update_plots = self._original_update_plots
            del self._original_update_plots

        # ------------------ ğŸ”¥ FIX: é‡æ–°æ·»åŠ  on_port_pair_change çš„ç›‘å¬ ğŸ”¥ ------------------
        # å¿…é¡»é‡æ–°æ·»åŠ  traceï¼Œç¡®ä¿åç»­æ­£å¸¸çš„ Port Pair åˆ‡æ¢å¯ä»¥å·¥ä½œ
        # ä½¿ç”¨æ–°çš„ ID è¦†ç›–æ—§ ID (å³ä½¿ trace_remove å¤±è´¥ï¼Œé‡æ–°æ·»åŠ ä¹Ÿå¯ä»¥)
        self._port_pair_change_trace_id = self.port_selection_var.trace_add("write", self.on_port_pair_change)
        # ------------------------------------------------------------------------------------

        # ------------------------------------------------------------
        # 12. Final UI Refresh (å¹¶æ‰§è¡Œå•æ¬¡ç»˜å›¾æ›´æ–°)
        # ------------------------------------------------------------
        # æ›´æ–°æ•°æ®ä¿¡æ¯ Tab ä¸­çš„åŠ¨æ€å†…å®¹ï¼ˆå¦‚ Treeviewï¼‰
        self.update_data_information_tab() 
        if hasattr(self, 'chart_tab'):
            self.notebook.select(self.chart_tab)

        self.update_file_list_ui()
        # âš ï¸ é›†ä¸­åœ¨æ­¤å¤„æ‰§è¡Œæœ€åä¸€æ¬¡ç»˜å›¾åˆ·æ–°ï¼Œæ›¿ä»£äº†ä¹‹å‰å¤šæ¬¡çš„éšå¼è°ƒç”¨
        self.update_plots() 

        # ------------------------------------------------------------
        # 13. User Feedback
        # ------------------------------------------------------------
        self.status_var.set("Application reset to initial state.")
        messagebox.showinfo("Reset Complete", "The application has been reset to its initial state.")
	#--------------------------------------------------	
